# Docker Compose configuration for Paperless-NGX Document Management
# Environment variables are loaded from .env file by default

version: "3.8"

services:
  # ================================================
  # PAPERLESS-NGX SERVICES
  # ================================================

  paperless-webserver:
    image: "ghcr.io/paperless-ngx/paperless-ngx:latest"
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-UTC}
      - PAPERLESS_REDIS=redis://paperless-redis:6379
      - PAPERLESS_DBENGINE=postgresql
      - PAPERLESS_DBHOST=paperless-db
      - PAPERLESS_DBNAME=${PAPERLESS_DB_NAME:-paperless}
      - PAPERLESS_DBUSER=${PAPERLESS_DB_USER:-paperless}
      - PAPERLESS_DBPASS=${PAPERLESS_DB_PASSWORD}
      - PAPERLESS_DBPORT=5432
      - PAPERLESS_SECRET_KEY=${PAPERLESS_SECRET_KEY}
      - PAPERLESS_URL=https://${PAPERLESS_DOMAIN:-paperless.local}
      - PAPERLESS_ADMIN_USER=${PAPERLESS_ADMIN_USER:-admin}
      - PAPERLESS_ADMIN_PASSWORD=${PAPERLESS_ADMIN_PASSWORD}
      - PAPERLESS_ADMIN_MAIL=${PAPERLESS_ADMIN_MAIL:-admin@yourdomain.com}
      - PAPERLESS_OCR_LANGUAGE=${PAPERLESS_OCR_LANGUAGE:-eng}
      - PAPERLESS_TIME_ZONE=${TZ:-UTC}
      - PAPERLESS_TIKA_ENABLED=${PAPERLESS_TIKA_ENABLED:-1}
      - PAPERLESS_TIKA_GOTENBERG_ENDPOINT=http://paperless-gotenberg:3000
      - PAPERLESS_TIKA_ENDPOINT=http://paperless-tika:9998
      - PAPERLESS_CONSUMER_POLLING=${PAPERLESS_CONSUMER_POLLING:-0}
      - PAPERLESS_CONSUMER_RECURSIVE=${PAPERLESS_CONSUMER_RECURSIVE:-true}
      - PAPERLESS_CONSUMER_SUBDIRS_AS_TAGS=${PAPERLESS_CONSUMER_SUBDIRS_AS_TAGS:-true}
      - PAPERLESS_TASK_WORKERS=${PAPERLESS_TASK_WORKERS:-2}
      - PAPERLESS_THREADS_PER_WORKER=${PAPERLESS_THREADS_PER_WORKER:-1}
    volumes:
      - paperless-data:/usr/src/paperless/data
      - paperless-media:/usr/src/paperless/media
      - paperless-export:/usr/src/paperless/export
      - paperless-consume:/usr/src/paperless/consume
    networks:
      - paperless
      - traefik-public
    depends_on:
      - paperless-db
      - paperless-redis
      - paperless-gotenberg
      - paperless-tika
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.paperless.rule=Host(`${PAPERLESS_DOMAIN:-paperless.local}`)"
      - "traefik.http.routers.paperless.entrypoints=web,websecure"
      - "traefik.http.routers.paperless.tls=true"
      - "traefik.http.routers.paperless.tls.certresolver=letsencrypt"
      - "traefik.http.services.paperless.loadbalancer.server.port=8000"
      - "traefik.docker.network=traefik-public"
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  paperless-db:
    image: "postgres:15"
    environment:
      - POSTGRES_DB=${PAPERLESS_DB_NAME:-paperless}
      - POSTGRES_USER=${PAPERLESS_DB_USER:-paperless}
      - POSTGRES_PASSWORD=${PAPERLESS_DB_PASSWORD}
      - TZ=${TZ:-UTC}
    volumes:
      - paperless-db:/var/lib/postgresql/data
    networks:
      - paperless
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  paperless-redis:
    image: "redis:7-alpine"
    volumes:
      - paperless-redis:/data
    networks:
      - paperless
    restart: unless-stopped
    command: redis-server --appendonly yes
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  paperless-gotenberg:
    image: "gotenberg/gotenberg:7"
    command:
      - "gotenberg"
      - "--chromium-disable-javascript=true"
      - "--chromium-allow-list=file:///tmp/.*"
    networks:
      - paperless
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  paperless-tika:
    image: "ghcr.io/paperless-ngx/tika:latest"
    networks:
      - paperless
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  paperless-ai:
    image: "clusterzx/paperless-ai"
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - PAPERLESS_AI_PORT=${PAPERLESS_AI_PORT:-3000}
      - RAG_SERVICE_URL=${RAG_SERVICE_URL:-http://localhost:8000}
      - RAG_SERVICE_ENABLED=${RAG_SERVICE_ENABLED:-true}
      - PAPERLESS_URL=http://paperless-webserver:8000
    ports:
      - "${PAPERLESS_AI_PORT:-3000}:${PAPERLESS_AI_PORT:-3000}"
    volumes:
      - paperless-ai-data:/app/data
    networks:
      - paperless
      - traefik-public
    restart: unless-stopped
    cap_drop:
      - ALL
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.paperless-ai.rule=Host(`${PAPERLESS_AI_DOMAIN:-paperless-ai.local}`)"
      - "traefik.http.routers.paperless-ai.entrypoints=web,websecure"
      - "traefik.http.routers.paperless-ai.tls=true"
      - "traefik.http.routers.paperless-ai.tls.certresolver=letsencrypt"
      - "traefik.http.services.paperless-ai.loadbalancer.server.port=${PAPERLESS_AI_PORT:-3000}"
      - "traefik.docker.network=traefik-public"
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

networks:
  traefik-public:
    external: true
    name: "traefik-public"

  paperless:
    driver: bridge

volumes:
  paperless-data:
  paperless-media:
    # Configure this volume externally for document storage
    # Example: docker volume create --driver local --opt type=nfs --opt o=addr=... paperless-media
  paperless-export:
  paperless-consume:
  paperless-db:
  paperless-redis:
  paperless-ai-data:
